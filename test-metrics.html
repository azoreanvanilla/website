<!DOCTYPE html>
<html>
<head>
  <title>Metric Cards Test</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    .test-section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
    .result { font-weight: bold; padding: 5px; margin: 5px 0; }
    .pass { background: #90EE90; }
    .fail { background: #FFB6C6; }
  </style>
</head>
<body>

<h1>Metric Cards Debug Test</h1>

<div class="test-section">
  <h2>HTML Elements</h2>
  <p>Temperature Range: <span id="card-temp-range">20â€“30Â°C (68â€“86Â°F)</span></p>
  <p>Humidity Range: <span id="card-hum-range">65â€“85% (Relative Humidity)</span></p>
  <p>VPD Range: <span id="card-vpd-range">0.8â€“1.5 kPa (Kilopascals)</span></p>
</div>

<div class="test-section" id="results">
  <h2>Test Results</h2>
  <div id="test-output"></div>
</div>

<script>
// Copy the exact code from script.js
const POLICIES = {
  "Dormancy": { m: [12, 1, 2], t_min: 18, t_max: 24, h_min: 65, h_max: 75, dv: 0.7, nv: 0.5, v_tol_day: 0.2, v_tol_night: 0.1 },
  "Awakening": { m: [3], t_min: 20, t_max: 26, h_min: 70, h_max: 80, dv: 0.8, nv: 0.6, v_tol_day: 0.25, v_tol_night: 0.15 },
  "Stress": { m: [4, 5], t_min: 22, t_max: 28, h_min: 75, h_max: 85, dv: 0.9, nv: 0.7, v_tol_day: 0.3, v_tol_night: 0.2 },
  "Flowering": { m: [6, 7], t_min: 23, t_max: 29, h_min: 70, h_max: 80, dv: 1.0, nv: 0.8, v_tol_day: 0.3, v_tol_night: 0.2 },
  "Maturation": { m: [8, 9, 10], t_min: 22, t_max: 28, h_min: 65, h_max: 75, dv: 0.8, nv: 0.6, v_tol_day: 0.25, v_tol_night: 0.15 },
  "Hardening": { m: [11], t_min: 20, t_max: 26, h_min: 60, h_max: 70, dv: 0.6, nv: 0.4, v_tol_day: 0.2, v_tol_night: 0.1 }
};

const SUN_DATA = {
  1: {rise: 7.9, set: 17.5}, 2: {rise: 7.6, set: 18.2}, 3: {rise: 7.1, set: 19.0}, 4: {rise: 6.5, set: 19.8},
  5: {rise: 6.0, set: 20.4}, 6: {rise: 5.7, set: 20.8}, 7: {rise: 5.9, set: 20.7}, 8: {rise: 6.3, set: 20.2},
  9: {rise: 6.7, set: 19.4}, 10: {rise: 7.2, set: 18.6}, 11: {rise: 7.8, set: 17.7}, 12: {rise: 8.1, set: 17.3}
};

const q = selector => document.querySelector(selector);

function isDaylight() {
  const now = new Date();
  const month = now.getMonth() + 1;
  const sun = SUN_DATA[month];
  const currentHour = now.getHours() + now.getMinutes() / 60;
  return currentHour >= sun.rise && currentHour <= sun.set;
}

function getVpdTolerance(policy) {
  return isDaylight() ? policy.v_tol_day : policy.v_tol_night;
}

function getCurrentPolicy() {
  const now = new Date();
  const month = now.getMonth() + 1;
  for (const [name, policy] of Object.entries(POLICIES)) {
    if (policy.m.includes(month)) {
      return { name, policy };
    }
  }
  return { name: "Dormancy", policy: POLICIES.Dormancy };
}

function updateMetricCardRanges() {
  if(!q('#card-temp-range')) return;
  
  const { name, policy } = getCurrentPolicy();
  const vpdTol = getVpdTolerance(policy);
  
  const tempRangeEl = q('#card-temp-range');
  if(tempRangeEl) {
    tempRangeEl.textContent = policy.t_min + 'â€“' + policy.t_max + 'Â°C (' + Math.round((policy.t_min * 9/5) + 32) + 'â€“' + Math.round((policy.t_max * 9/5) + 32) + 'Â°F)';
  }
  
  const humRangeEl = q('#card-hum-range');
  if(humRangeEl) {
    humRangeEl.textContent = policy.h_min + 'â€“' + policy.h_max + '% (Relative Humidity)';
  }
  
  const vpdRangeEl = q('#card-vpd-range');
  if(vpdRangeEl) {
    const vpdMin = (policy.dv - vpdTol).toFixed(2);
    const vpdMax = (policy.dv + vpdTol).toFixed(2);
    vpdRangeEl.textContent = vpdMin + 'â€“' + vpdMax + ' kPa (Kilopascals)';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const output = q('#test-output');
  const log = (msg, isPass) => {
    const div = document.createElement('div');
    div.className = 'result ' + (isPass ? 'pass' : 'fail');
    div.textContent = msg;
    output.appendChild(div);
    console.log(msg);
  };
  
  const {name, policy} = getCurrentPolicy();
  const vpdTol = getVpdTolerance(policy);
  
  log(`âœ“ getCurrentPolicy returned: ${name}`, true);
  log(`âœ“ VPD tolerance: ${vpdTol}`, true);
  
  log(`Before updateMetricCardRanges():`, true);
  log(`  Temp: ${q('#card-temp-range').textContent}`, true);
  log(`  Hum: ${q('#card-hum-range').textContent}`, true);
  log(`  VPD: ${q('#card-vpd-range').textContent}`, true);
  
  updateMetricCardRanges();
  
  log(`After updateMetricCardRanges():`, true);
  const tempVal = q('#card-temp-range').textContent;
  const humVal = q('#card-hum-range').textContent;
  const vpdVal = q('#card-vpd-range').textContent;
  
  log(`  Temp: ${tempVal}`, true);
  log(`  Hum: ${humVal}`, true);
  log(`  VPD: ${vpdVal}`, true);
  
  // Check if values are correct
  const tempCorrect = tempVal === '18â€“24Â°C (64â€“75Â°F)';
  const humCorrect = humVal === '65â€“75% (Relative Humidity)';
  const vpdCorrect = vpdVal === '0.60â€“0.80 kPa (Kilopascals)';
  
  log(`Temp correct: ${tempCorrect ? 'âœ… YES' : 'âŒ NO'}`, tempCorrect);
  log(`Humidity correct: ${humCorrect ? 'âœ… YES' : 'âŒ NO'}`, humCorrect);
  log(`VPD correct: ${vpdCorrect ? 'âœ… YES' : 'âŒ NO'}`, vpdCorrect);
  
  if(tempCorrect && humCorrect && vpdCorrect) {
    log('ğŸ‰ ALL TESTS PASSED!', true);
  } else {
    log('âŒ SOME TESTS FAILED', false);
  }
});
</script>

</body>
</html>
